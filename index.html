<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulasi Dashboard Pengaduan BPS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Library untuk QR Code Generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .status-badge {
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .status-baru { background-color: #e0f2fe; color: #0ea5e9; }
        .status-menunggu-jawaban-sme { background-color: #fef9c3; color: #eab308; }
        .status-siap-direview { background-color: #dcfce7; color: #22c55e; }
        .status-selesai { background-color: #f3f4f6; color: #6b7280; }
        .status-lewat-sla { background-color: #fee2e2; color: #ef4444; }
        .sidebar-item.active {
            background-color: #1e40af;
            color: #ffffff;
            font-weight: 600;
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .highlight-card {
            border: 2px solid #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
            transform: scale(1.02);
            transition: all 0.3s ease-in-out;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 32px;
            bottom: 0;
            width: 2px;
            background-color: #e5e7eb;
            z-index: 0;
        }
        .timeline-item:last-child::before {
            display: none;
        }
        .timeline-dot {
            z-index: 1;
        }
        .rating .star {
            cursor: pointer;
            color: #d1d5db; /* gray-300 */
            transition: color 0.2s;
        }
        .rating .star:hover,
        .rating .star.selected {
            color: #facc15; /* yellow-400 */
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="flex flex-col md:flex-row h-screen bg-gray-100">
        <!-- Sidebar -->
        <aside class="w-full md:w-72 bg-gray-800 text-white shadow-lg flex-shrink-0 flex flex-col">
            <div class="p-5 border-b border-gray-700">
                <h1 class="text-xl font-bold">SOP Digital Sistem Pengaduan</h1>
                <p class="text-sm text-gray-400">BPS Provinsi Sumatera Utara</p>
            </div>
            <nav id="sidebar-nav" class="p-4 space-y-2">
                 <a href="#" data-view="simulation" class="sidebar-item flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
                    <i data-lucide="play-circle" class="w-5 h-5"></i>
                    <span>Mulai Simulasi Baru</span>
                </a>
                <a href="#" data-view="tracking" class="sidebar-item flex items-center gap-3 px-4 py-2 rounded-lg text-gray-300 hover:bg-gray-700 hover:text-white">
                    <i data-lucide="qr-code" class="w-5 h-5"></i>
                    <span>Lacak Laporan</span>
                </a>
            </nav>
            <div id="timeline-container" class="p-5 space-y-2 mt-4 border-t border-gray-700 flex-1 overflow-y-auto">
                <!-- Timeline akan dirender di sini -->
            </div>
            <div id="reset-button-container" class="p-5 mt-auto hidden">
                 <button id="reset-button" class="w-full bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm font-semibold flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span>Ulangi Simulasi</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="main-content" class="flex-1 p-4 md:p-8 overflow-y-auto flex flex-col">
            <!-- Content will be rendered here by JavaScript -->
        </main>
    </div>

    <!-- Modal Container -->
    <div id="modal-container"></div>


    <script>
        // --- INITIAL STATE & DATA SIMULASI ---
        const defaultComplaintDetail = 'Selamat siang. Saya ingin melaporkan pelayanan di Kantor BPS Kota Medan. Petugas di loket 3 sangat tidak ramah dan tidak mau menjelaskan prosedur dengan baik saat saya bertanya tadi pagi.';
        const initialState = {
            currentView: 'simulation',
            currentStep: -1, // Start before the first step
            stepTimestamps: [],
            ppidInbox: [],
            complaints: [
                { id: 2, no_tiket: 'BPS-PENG-2507-002', status: 'Siap Direview', subjek_pengaduan: 'Dugaan pungli oleh oknum petugas', ditugaskan_ke: 'Tim Investigasi', pelapor: '+62857xxxx5678', detail: 'Ada oknum petugas berinisial A yang meminta "uang rokok" untuk mempercepat proses layanan. Mohon ditindaklanuti.', jawaban_sme: 'Setelah dilakukan pengecekan awal melalui CCTV dan wawancara saksi, kami menemukan indikasi kuat adanya pelanggaran. Tim akan melakukan pemeriksaan lebih lanjut sesuai prosedur internal. Terlampir adalah notulen investigasi awal.', lampiran_sme: 'notulen_investigasi.pdf' },
                { id: 5, no_tiket: 'BPS-PENG-2507-005', status: 'Selesai', subjek_pengaduan: 'Petugas tidak ramah', ditugaskan_ke: 'Tim SDM', pelapor: '+62813xxxx7890', detail: 'Petugas di loket 3 sangat tidak ramah dan tidak informatif saat saya bertanya.', jawaban_sme: 'Kami telah melakukan pembinaan terhadap petugas yang bersangkutan dan akan meningkatkan pengawasan serta pelatihan layanan pelanggan. Terima kasih atas laporannya.' },
            ],
            simulationComplaint: {
                id: 7,
                no_tiket: 'BPS-PENG-2507-007',
                status: 'Belum Ada',
                subjek_pengaduan: 'Pelayanan tidak ramah di Kantor BPS Kota Medan',
                ditugaskan_ke: '-',
                pelapor: '+62812xxxx3344',
                detail: defaultComplaintDetail,
                identitas: {}
            }
        };

        let state = JSON.parse(JSON.stringify(initialState));
        let trackingIntervalId = null;

        const timelineSteps = [
            { role: 'pelapor', title: 'Pelapor Mengisi Laporan', icon: 'file-plus-2' },
            { role: 'pelapor', title: 'Pelapor Mengisi Identitas', icon: 'user-plus' },
            { role: 'pelapor', title: 'Menerima Tiket & QR Code', icon: 'smartphone' },
            { role: 'ppid', title: 'PPID Melakukan Klasifikasi', icon: 'inbox' },
            { role: 'admin', title: 'Admin Melakukan Disposisi', icon: 'send' },
            { role: 'sme', title: 'SME Menjawab Aduan', icon: 'user-check' },
            { role: 'admin', title: 'Admin Review & Kirim Jawaban', icon: 'check-circle-2' },
            { role: 'pelapor', title: 'Pelapor Menerima Jawaban', icon: 'mail-check' },
            { role: 'pelapor', title: 'Pelapor Mengisi Survei', icon: 'star' }
        ];

        const mainContent = document.getElementById('main-content');
        const modalContainer = document.getElementById('modal-container');
        const timelineContainer = document.getElementById('timeline-container');
        const sidebarNav = document.getElementById('sidebar-nav');
        const resetButton = document.getElementById('reset-button');
        const resetButtonContainer = document.getElementById('reset-button-container');
        
        // --- HELPER FUNCTIONS ---
        const formatTime = (date) => {
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) + ' WIB';
        }
        
        const footerHTML = `<footer class="mt-auto pt-8 text-center text-xs text-gray-400">
            @2025 - Tim Layanan Pengembangan Kompetensi dan Hukum BPS Provinsi Sumatera Utara
        </footer>`;

        // --- RENDER FUNCTIONS ---
        function renderTimeline(steps = timelineSteps, currentStepIndex = state.currentStep, timestamps = state.stepTimestamps) {
            if (currentStepIndex < 0) {
                 timelineContainer.innerHTML = `<p class="text-sm text-gray-400">Timeline akan muncul saat simulasi berjalan.</p>`;
                 return;
            }
            timelineContainer.innerHTML = steps.map((step, index) => `
                <div class="timeline-item relative pl-10 pb-6">
                    <div class="timeline-dot absolute left-0 top-1 w-6 h-6 rounded-full flex items-center justify-center ${currentStepIndex >= index ? 'bg-blue-600 text-white' : 'bg-gray-600 text-gray-400'}">
                        <i data-lucide="${currentStepIndex > index ? 'check' : step.icon}" class="w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="font-semibold ${currentStepIndex === index ? 'text-white' : 'text-gray-400'}">${step.title}</p>
                        ${timestamps[index] ? `<p class="text-xs ${currentStepIndex === index ? 'text-blue-200' : 'text-gray-500'}">${formatTime(timestamps[index])}</p>` : ''}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function renderLoginView() {
            mainContent.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 text-center w-full max-w-md">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="shield-check" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">Simulasi Sistem Pengaduan</h2>
                        <p class="text-gray-500 mb-6">Masukkan kode di bawah untuk memulai simulasi alur kerja pengaduan interaktif.</p>
                        <div class="space-y-4">
                            <div>
                                <label for="simulation-code" class="sr-only">Kode Simulasi</label>
                                <input type="text" id="simulation-code" class="w-full p-3 text-center text-lg font-semibold border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan Kode Simulasi">
                                <p id="error-message" class="text-red-500 text-sm mt-2 h-4"></p>
                            </div>
                            <button id="login-button" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg flex items-center justify-center gap-3">
                                <i data-lucide="play" class="w-5 h-5"></i>
                                <span>Mulai Simulasi</span>
                            </button>
                        </div>
                        <p class="text-xs text-gray-400 mt-4">Gunakan kode: <strong class="font-mono">BPS-SIM-2025</strong></p>
                    </div>
                </div>
                ${footerHTML}
            `;
            document.getElementById('login-button').addEventListener('click', handleLogin);
            lucide.createIcons();
        }

        function renderInitialView() {
            mainContent.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center bg-white rounded-2xl shadow-lg p-8 ${state.currentStep === 0 ? 'highlight-card' : ''}">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mb-6">
                        <i data-lucide="file-plus-2" class="w-12 h-12 text-blue-600"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2">Langkah 1: Tulis Laporan Anda</h2>
                    <p class="max-w-xl text-gray-600 mb-6">Anda bisa menggunakan contoh yang ada atau mengetik laporan Anda sendiri.</p>
                    
                    <div class="w-full max-w-lg mb-6">
                        <label for="custom-report-input" class="block text-sm font-medium text-gray-700 mb-2 text-left">Isi Laporan Anda:</label>
                        <textarea id="custom-report-input" class="w-full p-3 border border-gray-300 rounded-lg h-28 text-sm" placeholder="${defaultComplaintDetail}"></textarea>
                    </div>

                    <button id="start-simulation-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold text-lg flex items-center gap-3 transition-transform transform hover:scale-105">
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                        <span>Lanjutkan ke Pengisian Identitas</span>
                    </button>
                </div>
                ${footerHTML}
            `;
            document.getElementById('start-simulation-btn').addEventListener('click', startSimulation);
            lucide.createIcons();
        }

        function renderIdentityFormView() {
            mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8 ${state.currentStep === 1 ? 'highlight-card' : ''}">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i data-lucide="user-plus" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Langkah 2: Lengkapi Identitas</h2>
                        <p class="text-gray-500 mt-1">Identitas yang jelas membantu kami menindaklanjuti laporan Anda.</p>
                    </div>
                    
                    <div class="mt-8 space-y-4">
                        <div>
                            <label for="identity-name" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="identity-name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="identity-address" class="block text-sm font-medium text-gray-700">Alamat</label>
                            <input type="text" id="identity-address" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="identity-phone" class="block text-sm font-medium text-gray-700">No. Telepon</label>
                            <input type="tel" id="identity-phone" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="identity-email" class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" id="identity-email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div class="flex items-start pt-2">
                            <div class="flex items-center h-5">
                                <input id="anonymous-checkbox" type="checkbox" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded">
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="anonymous-checkbox" class="font-medium text-gray-700">Saya ingin melapor secara anonim (tanpa nama)</label>
                                <p id="anonymous-warning" class="text-gray-500 hidden mt-1">Laporan dengan identitas yang jelas akan lebih mudah ditindaklanjuti.</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button id="submit-identity-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold">Lanjutkan & Dapatkan Tiket</button>
                    </div>
                </div>
                 ${footerHTML}
            `;
            lucide.createIcons();
            setupIdentityFormInteractions();
        }

        function renderPelaporView(isFinal = false) {
             mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-6 ${state.currentStep === 2 ? 'highlight-card' : ''}">
                    <h2 class="text-2xl font-bold text-center mb-1">Langkah 3: Tanda Terima & Pelacakan</h2>
                    <p class="text-center text-gray-500 mb-4">Laporan Anda berhasil dikirim!</p>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="w-full max-w-sm mx-auto bg-white border border-gray-200 rounded-lg shadow-sm p-4">
                            <div class="bg-blue-100 text-blue-800 p-3 rounded-lg ml-auto max-w-xs text-sm mb-4">
                                ${state.simulationComplaint.detail}
                            </div>
                            <div class="bg-gray-100 text-gray-800 p-3 rounded-lg mr-auto max-w-xs text-sm">
                                <p class="mb-2">Terima kasih telah menghubungi BPS. Laporan Anda telah kami terima.</p>
                                <p class="mb-2">Nomor Tiket Anda:<br><strong class="font-bold">${state.simulationComplaint.no_tiket}</strong></p>
                                <!-- Canvas untuk QR Code -->
                                <canvas id="qrcode-canvas" class="rounded-md mx-auto mt-2"></canvas>
                            </div>
                            ${isFinal ? `
                            <div class="bg-gray-100 text-gray-800 p-3 rounded-lg mr-auto max-w-xs text-sm mt-4">
                                <p class="font-bold mb-2">Jawaban Final:</p>
                                <p>Terima kasih atas laporan Anda. Kami telah melakukan pembinaan kepada petugas yang bersangkutan dan akan meningkatkan kualitas layanan kami.</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    ${state.currentStep === 2 ? `
                    <div class="text-center mt-6">
                        <p class="text-gray-600 mb-4">Sistem mengirimkan balasan otomatis ke WhatsApp pelapor. Alur selanjutnya akan berjalan di sistem internal BPS.</p>
                        <button id="continue-internal-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-bold">Lanjutkan ke Proses Internal</button>
                    </div>` : ''}
                    ${isFinal ? `
                    <div class="text-center mt-6">
                         <p class="text-gray-600 mb-4">Pelapor telah menerima jawaban final. Sistem secara otomatis akan menampilkan ajakan survei.</p>
                        <button id="show-survey-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-bold">Lanjutkan</button>
                    </div>
                    ` : ''}
                </div>
                 ${footerHTML}
            `;
            const canvas = document.getElementById('qrcode-canvas');
            if (canvas) {
                const urlToEncode = `https://bps.go.id/lacak?tiket=${state.simulationComplaint.no_tiket}`;
                QRCode.toCanvas(canvas, urlToEncode, { width: 180, margin: 2 }, function (error) {
                    if (error) console.error(error);
                });
            }
            if (state.currentStep === 2) {
                document.getElementById('continue-internal-btn').addEventListener('click', () => {
                    advanceStep();
                    state.ppidInbox.push({
                        id: 99,
                        pengirim: state.simulationComplaint.pelapor,
                        cuplikan: state.simulationComplaint.detail,
                        jenis: 'pengaduan'
                    },
                    {
                        id: 100,
                        pengirim: '+62818xxxx1234',
                        cuplikan: 'Selamat siang, saya mau tanya data inflasi bulan lalu bagaimana ya?',
                        jenis: 'permintaan'
                    });
                    updateView();
                });
            }
            if (isFinal) {
                 document.getElementById('show-survey-btn').addEventListener('click', () => {
                    openSurveyInvitationModal();
                });
            }
        }
        
        function renderPpidDashboard() {
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg ${state.currentStep === 3 ? 'highlight-card' : ''}">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold">Dashboard Verifikator - PPID</h2>
                        <div class="bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-full">
                            ${state.ppidInbox.length} Pesan Baru
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${state.ppidInbox.map((msg, index) => `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                <div class="font-medium">${msg.pengirim}</div>
                                <div class="text-gray-600 text-sm">${msg.cuplikan}</div>
                                <div class="flex justify-start md:justify-center gap-2">
                                     <button onclick="handlePpidAction(${index}, 'pengaduan')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm font-semibold flex items-center gap-2">
                                        <i data-lucide="shield-alert" class="w-4 h-4"></i>
                                        <span>Jadikan Pengaduan</span>
                                    </button>
                                    <button onclick="handlePpidAction(${index}, 'permintaan')" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-semibold flex items-center gap-2">
                                        <i data-lucide="database" class="w-4 h-4"></i>
                                        <span>Permintaan Data</span>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${state.currentStep === 3 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Laporan dari pelapor masuk ke inbox PPID. Petugas PPID harus mengklasifikasikannya.</p>
                        <p class="font-semibold">Klik salah satu tombol untuk melanjutkan.</p>
                    </div>` : ''}
                </div>
                 ${footerHTML}
            `;
            lucide.createIcons();
        }

        function renderAdminDashboard(isFinalReview = false) {
            const dataToShow = isFinalReview ? state.complaints.filter(c => c.id === state.simulationComplaint.id) : state.complaints;
            mainContent.innerHTML = `
                <div class="bg-white p-6 rounded-xl shadow-lg ${state.currentStep === 4 || state.currentStep === 6 ? 'highlight-card' : ''}">
                    <h2 class="text-2xl font-bold mb-6">Dashboard Manajemen Pengaduan</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                <tr><th class="p-3">No. Tiket</th><th class="p-3">Status</th><th class="p-3">Subjek Pengaduan</th><th class="p-3">Ditugaskan ke</th><th class="p-3 text-center">Aksi</th></tr>
                            </thead>
                            <tbody>
                                ${dataToShow.map(item => `
                                    <tr class="border-b hover:bg-gray-50 ${item.id === state.simulationComplaint.id ? 'bg-blue-50' : ''}">
                                        <td class="p-3 font-medium">${item.no_tiket}</td>
                                        <td class="p-3"><span class="status-badge status-${item.status.toLowerCase().replace(/ /g, '-')}">${item.status}</span></td>
                                        <td class="p-3">${item.subjek_pengaduan}</td>
                                        <td class="p-3">${item.ditugaskan_ke}</td>
                                        <td class="p-3 text-center">
                                            ${renderAdminActionButtons(item)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                     ${state.currentStep === 4 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Pengaduan baru muncul di dashboard Admin. Admin harus mendisposisikannya ke tim yang tepat.</p>
                        <p class="font-semibold">Klik tombol "Disposisi" pada laporan baru untuk melanjutkan.</p>
                    </div>` : ''}
                     ${state.currentStep === 6 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">Jawaban dari SME telah masuk. Admin harus mereview dan mengirimkan jawaban final ke pelapor.</p>
                        <p class="font-semibold">Klik tombol "Review & Jawab" untuk melanjutkan.</p>
                    </div>` : ''}
                </div>
                 ${footerHTML}
            `;
            lucide.createIcons();
        }
        
        function renderSmeDashboard() {
            const smeTasks = state.complaints.filter(c => c.status === 'Menunggu Jawaban SME' && c.id === state.simulationComplaint.id);
            mainContent.innerHTML = `
                 <div class="bg-white p-6 rounded-xl shadow-lg ${state.currentStep === 5 ? 'highlight-card' : ''}">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-2xl font-bold">Dashboard Tugas - SME</h2>
                    </div>
                    <div class="space-y-4">
                        ${smeTasks.length > 0 ? smeTasks.map(task => `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                <div class="font-medium">${task.no_tiket}</div>
                                <div class="text-gray-600 text-sm">${task.subjek_pengaduan}</div>
                                <div class="text-center">
                                    <button onclick="openSmeModal(${task.id})" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 text-sm font-semibold flex items-center gap-2 mx-auto">
                                        <i data-lucide="edit" class="w-4 h-4"></i>
                                        <span>Jawab Sekarang</span>
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500 py-8">Tidak ada tugas saat ini.</p>'}
                    </div>
                    ${state.currentStep === 5 ? `
                    <div class="text-center mt-6 bg-blue-50 p-4 rounded-lg">
                        <p class="text-gray-600 mb-4">${state.simulationComplaint.ditugaskan_ke} (SME) menerima tugas. Mereka harus melakukan investigasi dan memberikan jawaban.</p>
                        <p class="font-semibold">Klik "Jawab Sekarang" untuk membuka form jawaban.</p>
                    </div>` : ''}
                </div>
                 ${footerHTML}
            `;
            lucide.createIcons();
        }

        function renderSurveyView() {
             mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8 ${state.currentStep === 8 ? 'highlight-card' : ''}">
                    <div class="text-center">
                         <div class="relative w-24 h-24 mx-auto mb-4">
                            <svg viewBox="0 0 100 100" class="w-full h-full">
                                <defs><radialGradient id="grad1" cx="50%" cy="50%" r="50%" fx="50%" fy="50%"><stop offset="0%" style="stop-color:rgb(251, 113, 133);stop-opacity:1" /><stop offset="100%" style="stop-color:rgb(219, 39, 119);stop-opacity:1" /></radialGradient></defs>
                                <circle cx="50" cy="50" r="50" fill="url(#grad1)"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#1d4ed8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                </div>
                            </div>
                             <div class="absolute -top-2 -right-2 text-yellow-400 text-3xl animate-pulse">⭐</div>
                             <div class="absolute -bottom-2 -left-2 text-yellow-400 text-4xl">😊</div>
                        </div>
                        <h2 class="text-2xl font-bold">Secara keseluruhan, seberapa puas Anda?</h2>
                        <p class="text-gray-500 mt-1">dengan layanan pengaduan kami?</p>
                    </div>
                    
                    <div id="emoticon-rating" class="mt-8 grid grid-cols-5 gap-2">
                        <div class="emoticon-rating-item text-center p-2 rounded-lg border-2 border-transparent cursor-pointer" data-value="1">
                            <div class="text-5xl">😠</div><p class="text-xs font-semibold">Sangat Kecewa</p>
                        </div>
                        <div class="emoticon-rating-item text-center p-2 rounded-lg border-2 border-transparent cursor-pointer" data-value="2">
                            <div class="text-5xl">😞</div><p class="text-xs font-semibold">Kecewa</p>
                        </div>
                        <div class="emoticon-rating-item text-center p-2 rounded-lg border-2 border-transparent cursor-pointer" data-value="3">
                            <div class="text-5xl">😐</div><p class="text-xs font-semibold">Biasa Saja</p>
                        </div>
                        <div class="emoticon-rating-item text-center p-2 rounded-lg border-2 border-transparent cursor-pointer" data-value="4">
                            <div class="text-5xl">🙂</div><p class="text-xs font-semibold">Puas</p>
                        </div>
                        <div class="emoticon-rating-item text-center p-2 rounded-lg border-2 border-transparent cursor-pointer" data-value="5">
                            <div class="text-5xl">😍</div><p class="text-xs font-semibold">Sangat Puas</p>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button id="submit-emoticon-btn" class="w-full bg-gray-300 text-gray-500 px-8 py-3 rounded-lg font-bold cursor-not-allowed" disabled>Submit</button>
                    </div>
                </div>
                 ${footerHTML}
            `;
            setupSurveyInteractions();
        }
        
        function renderSurveyDetailView() {
            mainContent.innerHTML = `
                 <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8">
                     <div class="text-center">
                        <h2 class="text-2xl font-bold">Apa yang paling Anda sukai?</h2>
                        <p class="text-gray-500 mt-1">Pilih satu atau lebih aspek layanan kami.</p>
                    </div>
                    <div class="mt-8 flex flex-wrap justify-center gap-3">
                        <button class="tag-option border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-100">Kecepatan Respon</button>
                        <button class="tag-option border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-100">Kejelasan Informasi</button>
                        <button class="tag-option border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-100">Kemudahan Pelacakan</button>
                        <button class="tag-option border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-100">Sikap Petugas</button>
                        <button class="tag-option border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-100">Solusi yang Diberikan</button>
                        <button class="tag-option border-2 border-gray-300 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-100">Lainnya</button>
                    </div>
                    <div class="mt-8">
                        <label for="survey-impression" class="font-semibold mb-2 text-center block">Beritahu kami impresi Anda</label>
                        <textarea id="survey-impression" class="w-full p-3 border border-gray-300 rounded-lg h-24 text-sm" placeholder="Tuliskan kesan atau saran Anda di sini..."></textarea>
                    </div>
                     <div class="text-center mt-8">
                        <button id="submit-survey-detail-btn" class="w-full bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 font-bold">Kirim Survei</button>
                    </div>
                 </div>
                ${footerHTML}
            `;
            setupSurveyDetailInteractions();
        }
        
        function renderThankYouView() {
            const messages = ["Semoga sehat selalu!", "Semoga hari Anda menyenangkan!", "Terima kasih atas partisipasi Anda."];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];

            mainContent.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full text-center max-w-md">
                        <div class="w-24 h-24 text-7xl mx-auto mb-4 relative">
                            😊
                            <span class="absolute -top-2 -right-2 text-4xl animate-ping">❤️</span>
                            <span class="absolute -top-2 -right-2 text-4xl">❤️</span>
                        </div>
                        <h2 class="text-3xl font-bold mb-2">Terima Kasih Banyak!</h2>
                        <p class="text-gray-600 mb-6">Umpan balik Anda telah kami terima. Masukan Anda sangat berarti untuk perbaikan layanan kami di masa mendatang.</p>
                        <p class="text-gray-500 italic mb-6">"${randomMessage}"</p>
                        <button onclick="resetSimulation(false)" class="w-full bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300 font-semibold">Kembali ke Awal</button>
                    </div>
                </div>
                ${footerHTML}
            `;
        }


        function renderTrackingView() {
            mainContent.innerHTML = `
                <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8">
                     <div class="text-center">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-4 mx-auto">
                            <i data-lucide="search" class="w-8 h-8 text-blue-600"></i>
                        </div>
                        <h2 class="text-2xl font-bold">Lacak Laporan Anda</h2>
                        <p class="text-gray-500 mt-1">Masukkan nomor tiket untuk melihat progres.</p>
                    </div>
                    <div id="tracking-input-container" class="mt-8">
                        <input type="text" id="ticket-input" class="w-full p-3 text-center text-lg font-semibold border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Masukkan Nomor Tiket Anda">
                        <p class="text-xs text-gray-400 mt-2 text-center">Contoh: <strong class="font-mono">BPS-PENG-2507-007</strong></p>
                        <button id="track-ticket-btn" class="mt-4 w-full bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 font-bold">Lacak Tiket</button>
                    </div>
                    <div id="tracking-result-container" class="hidden mt-8">
                         <h3 class="font-semibold mb-4">Riwayat Progres:</h3>
                         <div id="tracking-timeline" class="space-y-1"></div>
                         <div id="tracking-survey-button" class="hidden mt-8">
                            <!-- Survey invitation will be a modal now -->
                        </div>
                    </div>
                </div>
                 ${footerHTML}
            `;
            document.getElementById('track-ticket-btn').addEventListener('click', handleTrackTicket);
            lucide.createIcons();
        }

        function renderAdminActionButtons(item) {
            if (item.id !== state.simulationComplaint.id) return `<span class="text-gray-400 text-sm">N/A</span>`;
            switch (item.status) {
                case 'Baru':
                    return `<button onclick="openDisposisiModal(${item.id})" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 text-sm font-semibold">Disposisi</button>`;
                case 'Siap Direview':
                    return `<button onclick="openReviewModal(${item.id})" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 text-sm font-semibold">Review & Jawab</button>`;
                default:
                    return `<span class="text-gray-400 text-sm">Menunggu</span>`;
            }
        }

        // --- MODAL & ACTION HANDLERS ---
        window.openDisposisiModal = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6">
                        <h3 class="text-xl font-bold mb-4">Disposisi Tiket: ${complaint.no_tiket}</h3>
                        <p class="mb-4 bg-gray-50 p-3 rounded-md text-sm">"${complaint.detail}"</p>
                        <label for="sme-select" class="block text-sm font-medium text-gray-700 mb-2">Tugaskan ke:</label>
                        <select id="sme-select" class="w-full p-2 border border-gray-300 rounded-md">
                            <option>Tim IT</option>
                            <option>Tim PST</option>
                            <option>Tim Keuangan</option>
                            <option>Tim Pengadaan</option>
                            <option>Tim Rumah Tangga</option>
                            <option>Tim Nerwilis</option>
                            <option>Tim IPDS</option>
                            <option>Tim Inovasi</option>
                            <option>Tim SDM</option>
                            <option>Sekretaris Pimpinan</option>
                            <option>Tim Humas</option>
                            <option>Tim Statistik Produksi</option>
                            <option>Tim Statistik Sosial</option>
                            <option>Lainnya</option>
                        </select>
                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="handleDisposisi(${id})" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">Kirim Disposisi</button>
                        </div>
                    </div>
                </div>`;
        }
        
        window.openReviewModal = (id) => {
             const complaint = state.complaints.find(c => c.id === id);
             modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl p-6">
                        <h3 class="text-xl font-bold mb-4">Review & Kirim Jawaban</h3>
                        <div class="space-y-4">
                            <div><h4 class="font-semibold">Pengaduan Asli:</h4><p class="bg-gray-50 p-3 rounded-md text-sm mt-1">"${complaint.detail}"</p></div>
                            <div><h4 class="font-semibold">Jawaban dari SME (${complaint.ditugaskan_ke}):</h4><p class="bg-blue-50 p-3 rounded-md text-sm mt-1">"${complaint.jawaban_sme}"</p></div>
                            <div><h4 class="font-semibold">Jawaban Final untuk Pelapor:</h4><textarea id="final-answer" class="w-full p-2 border border-gray-300 rounded-md mt-1 h-24 text-sm">Terima kasih atas laporan Anda. Kami telah melakukan pembinaan kepada petugas yang bersangkutan dan akan meningkatkan kualitas layanan kami.</textarea></div>
                        </div>
                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="handleSendAnswer(${id})" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 font-semibold">Kirim Jawaban Akhir</button>
                        </div>
                    </div>
                </div>`;
        }

        window.openSmeModal = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Jawab Pengaduan: ${complaint.no_tiket}</h3>
                        <div><h4 class="font-semibold">Detail Pengaduan:</h4><p class="bg-gray-50 p-3 rounded-md text-sm mt-1">"${complaint.detail}"</p></div>
                        <div class="mt-4"><label for="sme-answer" class="block text-sm font-medium mb-2">Jawaban Anda:</label><textarea id="sme-answer" class="w-full p-2 border rounded-md mt-1 h-24 text-sm">Telah dilakukan konfirmasi dan pembinaan langsung kepada petugas yang bersangkutan. Kami memohon maaf atas ketidaknyamanan yang terjadi. Sebagai tindak lanjut, kami akan mengadakan sesi penyegaran kembali mengenai standar pelayanan pelanggan untuk seluruh staf frontliner minggu depan.</textarea></div>
                        <div class="flex justify-end gap-4 mt-6">
                            <button onclick="handleSmeSubmit(${id})" class="bg-yellow-500 text-white px-6 py-2 rounded-lg hover:bg-yellow-600 font-semibold">Submit Jawaban ke Admin</button>
                        </div>
                    </div>
                </div>`;
        }
        
        window.openSurveyInvitationModal = () => {
            modalContainer.innerHTML = `
                <div class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="modal-content bg-white rounded-2xl shadow-2xl w-full max-w-sm p-8 text-center">
                         <div class="relative w-32 h-32 mx-auto mb-6">
                            <svg viewBox="0 0 100 100" class="w-full h-full">
                                <defs>
                                    <radialGradient id="grad1" cx="50%" cy="50%" r="50%" fx="50%" fy="50%">
                                        <stop offset="0%" style="stop-color:rgb(251, 113, 133);stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:rgb(219, 39, 119);stop-opacity:1" />
                                    </radialGradient>
                                </defs>
                                <circle cx="50" cy="50" r="50" fill="url(#grad1)"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#1d4ed8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                </div>
                            </div>
                            <div class="absolute top-2 right-2 text-yellow-400">
                               <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            </div>
                             <div class="absolute bottom-2 left-2 text-yellow-400 text-3xl">😊</div>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Bantu Kami untuk meningkatkan pelayanan,</h3>
                        <p class="text-gray-600 mb-6">dengan berpartisipasi pada survei kepuasan layanan PPID BPS Provinsi Sumatera Utara.</p>
                        <button id="modal-start-survey-btn" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-bold">Ikuti Survei</button>
                    </div>
                </div>`;
            document.getElementById('modal-start-survey-btn').addEventListener('click', () => {
                modalContainer.innerHTML = '';
                advanceStep();
                updateView();
            });
        }

        window.handlePpidAction = (index, type) => {
            const processedMessage = state.ppidInbox[index];
            if (type === 'pengaduan') {
                const newComplaint = { ...state.simulationComplaint, status: 'Baru' };
                state.complaints.unshift(newComplaint);
                advanceStep();
            } else {
                alert(`Pesan dari ${processedMessage.pengirim} telah diklasifikasikan sebagai PERMINTAAN DATA dan diteruskan ke alur yang sesuai.`);
            }
            state.ppidInbox.splice(index, 1);
            updateView();
        }

        window.handleDisposisi = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            const smeTeam = document.getElementById('sme-select').value;
            complaint.status = 'Menunggu Jawaban SME';
            complaint.ditugaskan_ke = smeTeam;
            modalContainer.innerHTML = '';
            advanceStep();
            updateView();
        }
        
        window.handleSmeSubmit = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            complaint.status = 'Siap Direview';
            complaint.jawaban_sme = document.getElementById('sme-answer').value;
            modalContainer.innerHTML = '';
            advanceStep();
            updateView();
        }

        window.handleSendAnswer = (id) => {
            const complaint = state.complaints.find(c => c.id === id);
            complaint.status = 'Selesai';
            modalContainer.innerHTML = '';
            advanceStep();
            updateView();
        }

        // --- SURVEY & MAIN APP LOGIC ---
        function setupSurveyInteractions() {
            document.getElementById('submit-emoticon-btn').addEventListener('click', renderSurveyDetailView);
            
            const emoticons = document.querySelectorAll('.emoticon-rating-item');
            const submitBtn = document.getElementById('submit-emoticon-btn');

            emoticons.forEach(emoticon => {
                emoticon.addEventListener('click', () => {
                    emoticons.forEach(e => e.classList.remove('selected'));
                    emoticon.classList.add('selected');
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-red-600', 'text-white', 'hover:bg-red-700');
                });
            });
        }

        function setupSurveyDetailInteractions() {
            document.querySelectorAll('.tag-option').forEach(tag => {
                tag.addEventListener('click', () => {
                    tag.classList.toggle('selected');
                });
            });
            document.getElementById('submit-survey-detail-btn').addEventListener('click', () => {
                resetSimulation(true);
            });
        }
        
        function setupIdentityFormInteractions() {
            const checkbox = document.getElementById('anonymous-checkbox');
            const warning = document.getElementById('anonymous-warning');
            const inputs = ['identity-name', 'identity-address', 'identity-phone', 'identity-email'].map(id => document.getElementById(id));

            checkbox.addEventListener('change', () => {
                const isChecked = checkbox.checked;
                warning.classList.toggle('hidden', !isChecked);
                inputs.forEach(input => {
                    input.disabled = isChecked;
                    input.required = !isChecked;
                    if (isChecked) {
                        input.value = 'Anonim';
                        input.classList.add('bg-gray-100');
                    } else {
                        input.value = '';
                        input.classList.remove('bg-gray-100');
                    }
                });
            });

            document.getElementById('submit-identity-btn').addEventListener('click', () => {
                if (!checkbox.checked && inputs.some(input => input.value.trim() === '')) {
                    alert('Harap isi semua kolom identitas atau pilih opsi anonim.');
                    return;
                }
                // Store identity data
                state.simulationComplaint.identitas.nama = document.getElementById('identity-name').value;
                state.simulationComplaint.identitas.alamat = document.getElementById('identity-address').value;
                // etc.

                advanceStep(); // Move to the next step (WhatsApp view)
                updateView();
            });
        }


        function updateView() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.sidebar-item[data-view="${state.currentView}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            if (state.currentView === 'simulation') {
                resetButtonContainer.classList.remove('hidden');
                renderTimeline();
                if (state.currentStep === -1) {
                    renderLoginView();
                    return;
                }
                switch (state.currentStep) {
                    case 0: renderInitialView(); break;
                    case 1: renderIdentityFormView(); break;
                    case 2: renderPelaporView(false); break;
                    case 3: renderPpidDashboard(); break;
                    case 4: renderAdminDashboard(false); break;
                    case 5: renderSmeDashboard(); break;
                    case 6: renderAdminDashboard(true); break;
                    case 7: renderPelaporView(true); break;
                    case 8: renderSurveyView(); break;
                }
            } else if (state.currentView === 'tracking') {
                resetButtonContainer.classList.add('hidden');
                timelineContainer.innerHTML = `<p class="text-sm text-gray-400">Mode Pelacakan Aktif.</p>`;
                renderTrackingView();
            }
        }
        
        function handleTrackTicket() {
            const ticketInput = document.getElementById('ticket-input').value;
            if (!ticketInput.trim()) {
                alert('Silakan masukkan nomor tiket.');
                return;
            }
            document.getElementById('tracking-input-container').classList.add('hidden');
            document.getElementById('tracking-result-container').classList.remove('hidden');

            const trackingTimelineEl = document.getElementById('tracking-timeline');
            let trackingStep = 0;
            let trackingTimestamps = [];
            
            clearInterval(trackingIntervalId);
            trackingIntervalId = setInterval(() => {
                trackingTimelineEl.innerHTML = '';
                const trackingSteps = timelineSteps.slice(2); // Start from "Menerima Tiket"
                if (!trackingTimestamps[trackingStep]) {
                    trackingTimestamps[trackingStep] = new Date();
                }

                for (let i = 0; i <= trackingStep; i++) {
                    const item = trackingSteps[i];
                    if (!item) continue;
                    const isCompleted = i < trackingStep;
                    const isActive = i === trackingStep;

                    const timelineItem = document.createElement('div');
                    timelineItem.className = "timeline-item relative pl-12 pb-6";
                    
                    let dotClass = 'bg-gray-300 text-gray-500';
                    if (isCompleted) dotClass = 'bg-green-500 text-white';
                    if (isActive) dotClass = 'bg-blue-500 text-white';

                    timelineItem.innerHTML = `<div class="timeline-dot absolute left-0 top-1 w-8 h-8 rounded-full flex items-center justify-center ${dotClass}"><i data-lucide="${isCompleted ? 'check' : item.icon}" class="w-5 h-5"></i></div><div><p class="font-semibold ${isActive ? 'text-blue-600' : ''}">${item.title}</p><p class="text-sm text-gray-500">${formatTime(trackingTimestamps[i])}</p></div>`;
                    trackingTimelineEl.appendChild(timelineItem);
                }
                lucide.createIcons();

                if (trackingStep < trackingSteps.length - 1) {
                    trackingStep++;
                } else {
                    clearInterval(trackingIntervalId);
                    openSurveyInvitationModal();
                }
            }, 1500);
        }

        function switchView(viewName, isFromTracking = false) {
            state.currentView = viewName;
            
            if (isFromTracking) {
                // Special case for survey from tracking page
                state.currentStep = 8;
                updateView();
            }
            else {
                state.currentStep = -1;
                clearInterval(trackingIntervalId);
                updateView();
            }
        }
        
        function advanceStep() {
            state.currentStep++;
            state.stepTimestamps[state.currentStep] = new Date();
        }

        function startSimulation() {
            const customReport = document.getElementById('custom-report-input').value;
            if (customReport.trim() !== '') {
                state.simulationComplaint.detail = customReport;
                state.simulationComplaint.subjek_pengaduan = customReport.substring(0, 50) + '...';
            } else {
                state.simulationComplaint.detail = defaultComplaintDetail;
                state.simulationComplaint.subjek_pengaduan = 'Pelayanan tidak ramah di Kantor BPS Kota Medan';
            }

            advanceStep();
            updateView();
        }
        
        function resetSimulation(showThankYou = false) {
            state = JSON.parse(JSON.stringify(initialState));
            state.currentView = 'simulation';
            state.currentStep = -1;
            if (showThankYou) {
                renderThankYouView();
                timelineContainer.innerHTML = '';
                resetButtonContainer.classList.add('hidden');
            } else {
                updateView();
            }
        }

        function handleLogin() {
            const codeInput = document.getElementById('simulation-code');
            const errorMsg = document.getElementById('error-message');
            const CORRECT_CODE = "BPS-SIM-2025";
            if (codeInput.value.toUpperCase() === CORRECT_CODE) {
                errorMsg.textContent = '';
                state.currentStep = 0;
                updateView();
            } else {
                errorMsg.textContent = 'Kode simulasi salah. Silakan coba lagi.';
            }
        }

        sidebarNav.addEventListener('click', (e) => {
            e.preventDefault();
            const targetLink = e.target.closest('.sidebar-item');
            if (targetLink) {
                const view = targetLink.dataset.view;
                if (view === 'simulation') {
                    resetSimulation();
                } else {
                    switchView(view);
                }
            }
        });
        
        resetButton.addEventListener('click', () => resetSimulation(false));
        
        // Initial Render
        lucide.createIcons();
        resetSimulation();

    </script>
</body>
</html>
